{% load static server_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Server Inventory</title>
    <link rel="stylesheet" href="{% static 'claude/css/server_list.css' %}">
</head>
<body>
    <div class="page-container">
        <!-- ZONE 1: FIXED HEADER -->
        <div class="header-zone">
            <div class="header">
                <h1>Server Inventory</h1>
                <div class="stats">
                    <div><strong>{{ total_servers }}</strong> unique servers</div>
                    <div><strong>{{ total_instances }}</strong> total instances</div>
                    <div>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</div>
                    <!--{% if has_filters %}
                        <div class="filter-info">
                            <span class="filter-active-icon">üîç</span>
                            Active filters - Some data may be hidden
                        </div>
                    {% endif %}-->
                    
                    <!-- Display mode toggle -->
                    <div class="view-toggle">
                        {% if flat_view %}
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'view' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="view-btn active">üìã Flat view</a>
                            <a href="?view=grouped{% for k,v in request.GET.items %}{% if k != 'view' %}&{{ k }}={{ v }}{% endif %}{% endfor %}" class="view-btn">üìÅ Grouped view</a>
                        {% else %}
                            <a href="?view=flat{% for k,v in request.GET.items %}{% if k != 'view' %}&{{ k }}={{ v }}{% endif %}{% endfor %}" class="view-btn">üìã Flat view</a>
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'view' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="view-btn active">üìÅ Grouped view</a>
                        {% endif %}
                    </div>
                    
                    <!-- Edit mode toggle -->
                    <div class="edit-toggle">
                        {% if edit_mode %}
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'edit' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="edit-btn">‚úèÔ∏è Edit mode</a>
                        {% else %}
                            <a href="?edit=true{% for k,v in request.GET.items %}&{{ k }}={{ v }}{% endfor %}" class="edit-btn active">üìù Enable editing</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Filter form -->
            <div class="filters-container">
                <form method="get" class="filters-form">
                    <div class="filter-row">
                        <div class="filter-group">
                            <label for="filter-hostname">Hostname:</label>
                            <input type="text" id="filter-hostname" name="hostname" value="{{ current_filters.hostname }}" placeholder="Search hostname...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-os">OS:</label>
                            <select id="filter-os" name="os">
                                <option value="">All OS</option>
                                {% for os in filter_stats.os_choices %}
                                    <option value="{{ os }}" {% if current_filters.os == os %}selected{% endif %}>{{ os }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-datacenter">Datacenter:</label>
                            <select id="filter-datacenter" name="datacenter">
                                <option value="">All datacenters</option>
                                {% for datacenter in filter_stats.datacenter_choices %}
                                    <option value="{{ datacenter }}" {% if current_filters.datacenter == datacenter %}selected{% endif %}>{{ datacenter }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-owner">Owner:</label>
                            <select id="filter-owner" name="owner">
                                <option value="">All owners</option>
                                {% for owner in filter_stats.owner_choices %}
                                    <option value="{{ owner }}" {% if current_filters.owner == owner %}selected{% endif %}>{{ owner }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-application">Application:</label>
                            <input type="text" id="filter-application" name="application" value="{{ current_filters.application }}" placeholder="Search application...">
                        </div>
                        
                        <div class="filter-actions">
                            <button type="submit" class="btn-filter">Filter</button>
                            <a href="?{% if flat_view %}view=flat{% endif %}" class="btn-clear">Reset</a>
                        </div>
                    </div>
                    
                    <!-- Preserve view and edit mode -->
                    {% if flat_view %}
                        <input type="hidden" name="view" value="flat">
                    {% endif %}
                    {% if edit_mode %}
                        <input type="hidden" name="edit" value="true">
                    {% endif %}
                    
                    <!-- Preserve current page when filtering -->
                    {% if request.GET.page and not request.GET.hostname and not request.GET.os and not request.GET.datacenter and not request.GET.owner and not request.GET.application %}
                        <input type="hidden" name="page" value="{{ request.GET.page }}">
                    {% endif %}
                </form>
                
                <!-- Active filter indicators -->
                {% if current_filters.hostname or current_filters.os or current_filters.datacenter or current_filters.owner or current_filters.application %}
                <div class="active-filters">
                    <span class="filter-label">Active filters:</span>
                    {% if current_filters.hostname %}
                        <span class="filter-tag">Hostname: {{ current_filters.hostname }} 
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'hostname' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="remove-filter">√ó</a>
                        </span>
                    {% endif %}
                    {% if current_filters.os %}
                        <span class="filter-tag">OS: {{ current_filters.os }} 
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'os' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="remove-filter">√ó</a>
                        </span>
                    {% endif %}
                    {% if current_filters.datacenter %}
                        <span class="filter-tag">Datacenter: {{ current_filters.datacenter }} 
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'datacenter' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="remove-filter">√ó</a>
                        </span>
                    {% endif %}
                    {% if current_filters.owner %}
                        <span class="filter-tag">Owner: {{ current_filters.owner }} 
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'owner' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="remove-filter">√ó</a>
                        </span>
                    {% endif %}
                    {% if current_filters.application %}
                        <span class="filter-tag">Application: {{ current_filters.application }} 
                            <a href="?{% for k,v in request.GET.items %}{% if k != 'application' %}{{ k }}={{ v }}&{% endif %}{% endfor %}" class="remove-filter">√ó</a>
                        </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
        </div>

        <!-- ZONE 2: MAIN CONTENT -->
        <div class="main-zone">
            <!-- Side panel for column controls -->
            <div class="sidebar-panel" id="columnPanel">
                <div class="panel-header">
                    <h4>Columns</h4>
                    <button class="panel-toggle" onclick="toggleColumnPanel()" title="Show/Hide column panel">‚Äπ</button>
                </div>
                <div class="panel-content">
                    <!-- Checkboxes will be generated by JavaScript -->
                </div>
            </div>

            <!-- Main content -->
            <div class="main-content">
                <div class="table-container">
                    <table>
                        <thead class="sticky-header">
                            {% if not flat_view %}
                            <th class="col-expand">+/-</th>
                            <th class="col-info">Info</th>
                            {% endif %}
                            {% for field in model_fields %}
                                <th class="col-{{ field.name }}">{{ field.verbose_name }}</th>
                            {% endfor %}
                        </thead>
                        <tbody>
                            {% for server_group in page_obj %}
                            <!-- Main row (adapted according to mode) -->
                            <tr class="server-row {% if flat_view %}flat-row{% else %}primary-row{% endif %}" data-hostname="{{ server_group.hostname }}" id="{% if not flat_view %}primary-{% endif %}{{ server_group.hostname|slugify }}{% if flat_view %}-{{ forloop.counter }}{% endif %}">
                                {% if not flat_view %}
                                <td class="col-expand">
                                    {% if server_group.count > 1 %}
                                        <button class="expand-btn" onclick="toggleDetails('{{ server_group.hostname|slugify }}')">
                                            +
                                        </button>
                                    {% endif %}
                                </td>
                                
                                <td class="col-info">
                                    <span class="instance-count {% if server_group.has_hidden %}has-filtered{% endif %}">
                                        {{ server_group.count }}
                                        {% if server_group.has_hidden %}
                                            <span class="hidden-indicator" title="{{ server_group.hidden_count }} occurrence(s) hidden by filters">
                                                /{{ server_group.total_count }}
                                            </span>
                                        {% endif %}
                                    </span>
                                </td>
                                {% endif %}
                                
                                {% for field in model_fields %}
                                <td class="col-{{ field.name }} field-value {% if field.is_hostname %}hostname-cell{% endif %}">
                                    {% if field.name == 'annotations' %}
                                        <!-- Annotations column -->
                                        {% if server_group.annotation %}
                                            <div class="annotation-display">
                                                {% if server_group.annotation.notes %}
                                                    <span class="annotation-notes" title="{{ server_group.annotation.get_display_status }} - Priority: {{ server_group.annotation.priority }}">
                                                        {{ server_group.annotation.notes|truncatechars:50 }}
                                                    </span>
                                                {% else %}
                                                    <span class="annotation-status {{ server_group.annotation.get_priority_badge_class }}">
                                                        {{ server_group.annotation.get_display_status }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        {% if edit_mode %}
                                            <button class="btn-edit-annotation" onclick="editAnnotation('{{ server_group.hostname }}');">
                                                {% if server_group.annotation %}‚úèÔ∏è{% else %}‚ûï{% endif %}
                                            </button>
                                        {% endif %}
                                    {% elif flat_view %}
                                        <!-- Flat mode: display server values directly -->
                                        {% with field_value=server_group.primary_server|lookup:field.name %}
                                            {% if field.is_hostname %}
                                                <strong>{{ field_value }}</strong>
                                            {% elif field_value %}
                                                {{ field_value }}
                                            {% else %}
                                                <span class="empty-field">-</span>
                                            {% endif %}
                                        {% endwith %}
                                    {% else %}
                                        <!-- Grouped mode: existing logic -->
                                        {% if field.name in server_group.constant_fields %}
                                            {% if field.is_hostname %}
                                                <strong>{{ server_group.constant_fields|lookup:field.name }}</strong>
                                            {% else %}
                                                {{ server_group.constant_fields|lookup:field.name }}
                                            {% endif %}
                                        {% elif field.name in server_group.variable_fields %}
                                            <span class="variable-field">{{ server_group.variable_fields|lookup:field.name|lookup:"preview" }}</span>
                                        {% else %}
                                            -
                                        {% endif %}
                                    {% endif %}
                                </td>
                                {% endfor %}
                            </tr>
                            
                            <!-- Detail rows (only in grouped mode) -->
                            {% if not flat_view and server_group.count > 1 %}
                                {% for instance in server_group.all_instances %}
                                <tr class="server-row detail-row" data-hostname="{{ server_group.hostname }}" id="detail-{{ server_group.hostname|slugify }}-{{ forloop.counter }}" style="display: none;">
                                    <td class="col-expand">
                                        {% if forloop.first %}
                                            <button class="expand-btn expanded" onclick="toggleDetails('{{ server_group.hostname|slugify }}')">
                                                ‚àí
                                            </button>
                                        {% endif %}
                                    </td>
                                    
                                    <td class="col-info">
                                        <span class="instance-badge {% if server_group.has_hidden %}has-filtered{% endif %}"
                                              {% if server_group.has_hidden %}title="Showing {{ server_group.count }} of {{ server_group.total_count }} total instances"{% endif %}>
                                            {{ forloop.counter }}/{{ server_group.count }}{% if server_group.has_hidden %} *{% endif %}
                                        </span>
                                    </td>
                                    
                                    {% for field in model_fields %}
                                    <td class="col-{{ field.name }} field-value {% if field.is_hostname %}hostname-cell{% endif %}">
                                        {% if field.name == 'annotations' %}
                                            <!-- Annotations column for detail rows -->
                                            {% if server_group.annotation %}
                                                <div class="annotation-display">
                                                    {% if server_group.annotation.notes %}
                                                        <span class="annotation-notes" title="{{ server_group.annotation.get_display_status }} - Priority: {{ server_group.annotation.priority }}">
                                                            {{ server_group.annotation.notes|truncatechars:50 }}
                                                        </span>
                                                    {% else %}
                                                        <span class="annotation-status {{ server_group.annotation.get_priority_badge_class }}">
                                                            {{ server_group.annotation.get_display_status }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                            {% endif %}
                                            {% if edit_mode and forloop.first %}
                                                <button class="btn-edit-annotation" onclick="editAnnotation('{{ server_group.hostname }}');">
                                                    {% if server_group.annotation %}‚úèÔ∏è{% else %}‚ûï{% endif %}
                                                </button>
                                            {% endif %}
                                        {% else %}
                                            {% with field_value=instance|lookup:field.name %}
                                                {% if field.is_hostname %}
                                                    <strong>{{ field_value }}</strong>
                                                {% elif field_value %}
                                                    {{ field_value }}
                                                {% else %}
                                                    <span class="empty-field">-</span>
                                                {% endif %}
                                            {% endwith %}
                                        {% endif %}
                                    </td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            {% endif %}
                            {% empty %}
                            <tr>
                                <td colspan="{% if flat_view %}{{ model_fields|length }}{% else %}{{ model_fields|length|add:2 }}{% endif %}" style="text-align: center; padding: 40px; color: #6c757d;">
                                    No servers found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div class="pagination-zone">
    <div class="pagination">
        {% if page_obj.has_other_pages %}
            {% if page_obj.has_previous %}
                <a href="?page=1{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">First</a>
                <a href="?page={{ page_obj.previous_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Previous</a>
            {% endif %}
            
            <span class="current">{{ page_obj.number }}</span>
            
            {% if page_obj.has_next %}
                <a href="?page={{ page_obj.next_page_number }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Next</a>
                <a href="?page={{ page_obj.paginator.num_pages }}{% for k,v in request.GET.items %}{% if k != 'page' %}&{{ k }}={{ v }}{% endif %}{% endfor %}">Last</a>
            {% endif %}
        {% endif %}
    </div>
</div>
            </div>
        </div>


    <!-- Annotation editing modal -->
    <div id="annotationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit annotation</h3>
                <button class="modal-close" onclick="closeAnnotationModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="annotationForm">
                    <div class="form-group">
                        <label for="modal-hostname">Server:</label>
                        <input type="text" id="modal-hostname" name="hostname" readonly>
                    </div>
                    
                    <div class="form-group">
                        <label for="status">Status:</label>
                        <select id="status" name="status" onchange="toggleCustomStatus()">
                            <option value="production">In production</option>
                            <option value="maintenance">Under maintenance</option>
                            <option value="upgrade_needed">Needs upgrade</option>
                            <option value="decommission">To decommission</option>
                            <option value="monitoring">Under monitoring</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="customStatusGroup" style="display: none;">
                        <label for="custom_status">Custom status:</label>
                        <input type="text" id="custom_status" name="custom_status" placeholder="Enter custom status">
                    </div>
                    
                    <div class="form-group">
                        <label for="priority">Priority:</label>
                        <select id="priority" name="priority">
                            <option value="low">Low</option>
                            <option value="normal">Normal</option>
                            <option value="high">High</option>
                            <option value="critical">Critical</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes:</label>
                        <textarea id="notes" name="notes" rows="4" placeholder="Comments and detailed notes..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn-cancel" onclick="closeAnnotationModal()">Cancel</button>
                <button class="btn-save" onclick="saveAnnotation()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // Function to toggle column panel
        function toggleColumnPanel() {
            const panel = document.getElementById('columnPanel');
            panel.classList.toggle('collapsed');
            
            // Save state in localStorage
            const isCollapsed = panel.classList.contains('collapsed');
            localStorage.setItem('columnPanelCollapsed', isCollapsed);
        }
        
        // Restore panel state on load
        document.addEventListener('DOMContentLoaded', function() {
            const wasCollapsed = localStorage.getItem('columnPanelCollapsed') === 'true';
            if (wasCollapsed) {
                document.getElementById('columnPanel').classList.add('collapsed');
            }
            
            // Function presence test
            console.log('[Debug] editAnnotation function:', typeof editAnnotation);
            console.log('[Debug] Modal element:', document.getElementById('annotationModal'));
        });
    </script>
    
    <script src="{% static 'claude/js/column-manager.js' %}"></script>
    <script src="{% static 'claude/js/annotation-manager.js' %}"></script>
    <script src="{% static 'claude/js/server_list.js' %}"></script>
</body>
</html>