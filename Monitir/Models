from django.db import models
from django.utils import timezone

class NodeHealthStatus(models.Model):
“””
Stocke l’état de santé de chaque node.
Chaque node écrit régulièrement son propre état.
“””

```
node_name = models.CharField(
    max_length=100,
    unique=True,
    db_index=True,
    help_text="Nom unique du node (ex: prod-node-01)"
)

status = models.CharField(
    max_length=20,
    choices=[
        ('OK', 'OK'),
        ('Warning', 'Warning'),
        ('Error', 'Error'),
        ('Unknown', 'Unknown'),
    ],
    default='Unknown',
    help_text="État global du node"
)

checks_data = models.JSONField(
    default=dict,
    help_text="Détails de tous les checks effectués"
)

last_updated = models.DateTimeField(
    auto_now=True,
    db_index=True,
    help_text="Dernière mise à jour du statut"
)

hostname = models.CharField(
    max_length=255,
    blank=True,
    help_text="Hostname système du serveur"
)

ip_address = models.GenericIPAddressField(
    null=True,
    blank=True,
    help_text="Adresse IP du node"
)

version = models.CharField(
    max_length=50,
    blank=True,
    help_text="Version de l'application"
)

class Meta:
    db_table = 'node_health_status'
    verbose_name = 'Node Health Status'
    verbose_name_plural = 'Node Health Statuses'
    ordering = ['node_name']

def __str__(self):
    return f"{self.node_name} - {self.status} (updated {self.last_updated})"

def is_stale(self, max_age_seconds=120):
    """
    Vérifie si le statut est périmé.
    Par défaut, considère périmé si > 2 minutes.
    """
    if not self.last_updated:
        return True
    
    age = (timezone.now() - self.last_updated).total_seconds()
    return age > max_age_seconds

def get_staleness_seconds(self):
    """Retourne l'âge du statut en secondes."""
    if not self.last_updated:
        return None
    return (timezone.now() - self.last_updated).total_seconds()

@classmethod
def update_node_status(cls, node_name, status, checks_data, hostname=None, ip_address=None, version=None):
    """
    Met à jour ou crée le statut d'un node.
    """
    obj, created = cls.objects.update_or_create(
        node_name=node_name,
        defaults={
            'status': status,
            'checks_data': checks_data,
            'hostname': hostname,
            'ip_address': ip_address,
            'version': version,
        }
    )
    return obj
```
