#!/usr/bin/env python
“””
Script de test pour valider l’installation du monitoring de cluster.
Lance ce script après avoir intégré tous les composants.

Usage:
python test_cluster_monitoring.py
“””

import sys
import os
import django

# Setup Django

os.environ.setdefault(‘DJANGO_SETTINGS_MODULE’, ‘your_project.settings’)
django.setup()

from django.db import connection
from api.models import NodeHealthStatus
from django.core.management import call_command
import requests
import time

class Colors:
GREEN = ‘\033[92m’
RED = ‘\033[91m’
YELLOW = ‘\033[93m’
BLUE = ‘\033[94m’
END = ‘\033[0m’

def print_test(name, success, message=””):
symbol = f”{Colors.GREEN}✓{Colors.END}” if success else f”{Colors.RED}✗{Colors.END}”
print(f”{symbol} {name}”)
if message:
print(f”  → {message}”)

def test_database_connection():
“”“Test 1: Vérifier la connexion à la DB”””
try:
with connection.cursor() as cursor:
cursor.execute(“SELECT 1”)
return True, “DB connectée”
except Exception as e:
return False, f”Erreur DB: {e}”

def test_table_exists():
“”“Test 2: Vérifier que la table node_health_status existe”””
try:
NodeHealthStatus.objects.count()
return True, “Table node_health_status existe”
except Exception as e:
return False, f”Table manquante: {e}”

def test_model_methods():
“”“Test 3: Vérifier les méthodes du modèle”””
try:
# Créer un node de test
node = NodeHealthStatus.update_node_status(
node_name=‘test-node’,
status=‘OK’,
checks_data={‘test’: ‘data’},
hostname=‘test.local’
)

```
    # Vérifier les méthodes
    staleness = node.get_staleness_seconds()
    is_stale = node.is_stale(120)
    
    # Nettoyer
    node.delete()
    
    return True, f"Méthodes OK (staleness: {staleness:.2f}s)"
except Exception as e:
    return False, f"Erreur méthodes: {e}"
```

def test_management_command():
“”“Test 4: Tester la commande update_node_health”””
try:
# Supprimer les anciens tests
NodeHealthStatus.objects.filter(node_name__startswith=‘test-’).delete()

```
    # Lancer la commande
    call_command('update_node_health', verbosity=0)
    
    # Vérifier qu'un node a été créé
    count = NodeHealthStatus.objects.count()
    if count > 0:
        latest = NodeHealthStatus.objects.latest('last_updated')
        return True, f"Node créé: {latest.node_name} ({latest.status})"
    else:
        return False, "Aucun node créé"
        
except Exception as e:
    return False, f"Erreur commande: {e}"
```

def test_cluster_api(base_url=‘http://localhost:8000’):
“”“Test 5: Tester l’API /api/status/cluster”””
try:
response = requests.get(f”{base_url}/api/status/cluster”, timeout=5)

```
    if response.status_code in [200, 503]:
        data = response.json()
        
        # Vérifier la structure
        required_keys = ['cluster_status', 'timestamp', 'summary', 'nodes']
        if all(key in data for key in required_keys):
            nodes_count = len(data['nodes'])
            cluster_status = data['cluster_status']
            return True, f"API OK - {nodes_count} node(s), status: {cluster_status}"
        else:
            return False, "Structure JSON invalide"
    else:
        return False, f"HTTP {response.status_code}"
        
except requests.exceptions.ConnectionError:
    return False, "Serveur non accessible (as-tu lancé runserver ?)"
except Exception as e:
    return False, f"Erreur API: {e}"
```

def test_staleness_detection():
“”“Test 6: Tester la détection de staleness”””
try:
# Créer un node avec une date ancienne
from django.utils import timezone
from datetime import timedelta

```
    old_node = NodeHealthStatus(
        node_name='stale-test-node',
        status='OK',
        checks_data={},
        hostname='test'
    )
    old_node.save()
    
    # Modifier manuellement le last_updated
    NodeHealthStatus.objects.filter(node_name='stale-test-node').update(
        last_updated=timezone.now() - timedelta(minutes=5)
    )
    
    # Récupérer et tester
    old_node.refresh_from_db()
    is_stale = old_node.is_stale(120)  # 2 minutes threshold
    
    # Nettoyer
    old_node.delete()
    
    if is_stale:
        return True, "Détection staleness OK"
    else:
        return False, "Staleness non détecté"
        
except Exception as e:
    return False, f"Erreur test staleness: {e}"
```

def main():
print(f”\n{Colors.BLUE}{’=’*60}{Colors.END}”)
print(f”{Colors.BLUE}  Test du système de monitoring de cluster{Colors.END}”)
print(f”{Colors.BLUE}{’=’*60}{Colors.END}\n”)

```
tests = [
    ("Connexion DB", test_database_connection),
    ("Table node_health_status", test_table_exists),
    ("Méthodes du modèle", test_model_methods),
    ("Commande update_node_health", test_management_command),
    ("Détection staleness", test_staleness_detection),
    ("API /api/status/cluster", lambda: test_cluster_api()),
]

results = []
for name, test_func in tests:
    try:
        success, message = test_func()
        print_test(name, success, message)
        results.append(success)
    except Exception as e:
        print_test(name, False, f"Exception: {e}")
        results.append(False)
    
    time.sleep(0.1)

# Résumé
print(f"\n{Colors.BLUE}{'='*60}{Colors.END}")
passed = sum(results)
total = len(results)

if passed == total:
    print(f"{Colors.GREEN}✓ Tous les tests passent ({passed}/{total}){Colors.END}")
    print(f"\n{Colors.GREEN}Le système est opérationnel !{Colors.END}")
    print(f"\nProchaines étapes :")
    print(f"  1. Configure le cron pour update_node_health (toutes les 30s)")
    print(f"  2. Lance le même setup sur le node 2")
    print(f"  3. Vérifie /api/status/cluster")
    sys.exit(0)
else:
    print(f"{Colors.RED}✗ {total - passed} test(s) échoué(s) ({passed}/{total}){Colors.END}")
    print(f"\n{Colors.YELLOW}Vérifie les erreurs ci-dessus.{Colors.END}")
    sys.exit(1)
```

if **name** == ‘**main**’:
main()
