#!/bin/bash

# setup_health_monitoring.sh

# Script pour configurer le monitoring automatique des nodes

echo “=== Configuration du Health Monitoring ===”

# 1. Créer un script wrapper pour la commande Django

cat > /opt/app/scripts/update_node_health.sh << ‘EOF’
#!/bin/bash

# Script pour mettre à jour le statut du node

cd /opt/app  # Adapter selon ton path
source venv/bin/activate  # Si tu utilises un virtualenv

# Exécuter la commande Django

python manage.py update_node_health –node-name=”$NODE_NAME”

# Log le résultat

if [ $? -eq 0 ]; then
echo “$(date ‘+%Y-%m-%d %H:%M:%S’) - Health check OK” >> /var/log/node_health.log
else
echo “$(date ‘+%Y-%m-%d %H:%M:%S’) - Health check FAILED” >> /var/log/node_health.log
fi
EOF

chmod +x /opt/app/scripts/update_node_health.sh

# 2. Option A : Configuration avec CRON (classique)

echo “”
echo “=== Option A : Configuration CRON ===”
echo “Ajouter cette ligne dans crontab (crontab -e) :”
echo “”
echo “# Mise à jour du health status toutes les 30 secondes”
echo “* * * * * /opt/app/scripts/update_node_health.sh”
echo “* * * * * sleep 30; /opt/app/scripts/update_node_health.sh”
echo “”

# 3. Option B : Configuration avec systemd timer (moderne)

echo “=== Option B : Configuration systemd (recommandé) ===”

# Service

cat > /tmp/node-health.service << ‘EOF’
[Unit]
Description=Node Health Status Update
After=network.target postgresql.service

[Service]
Type=oneshot
User=www-data
Group=www-data
WorkingDirectory=/opt/app
Environment=“NODE_NAME=prod-node-01”
ExecStart=/opt/app/scripts/update_node_health.sh
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
EOF

# Timer

cat > /tmp/node-health.timer << ‘EOF’
[Unit]
Description=Run node health check every 30 seconds
Requires=node-health.service

[Timer]
OnBootSec=10s
OnUnitActiveSec=30s
AccuracySec=1s

[Install]
WantedBy=timers.target
EOF

echo “Fichiers systemd créés dans /tmp/”
echo “Pour installer :”
echo “  sudo cp /tmp/node-health.service /etc/systemd/system/”
echo “  sudo cp /tmp/node-health.timer /etc/systemd/system/”
echo “  sudo systemctl daemon-reload”
echo “  sudo systemctl enable node-health.timer”
echo “  sudo systemctl start node-health.timer”
echo “”
echo “Pour vérifier :”
echo “  sudo systemctl status node-health.timer”
echo “  sudo systemctl list-timers –all”
echo “”

# 4. Option C : Utiliser Django-Q ou Celery Beat (pour les gros projets)

echo “=== Option C : Django-Q ou Celery Beat ===”
echo “Si tu utilises déjà des workers async, tu peux scheduler la task :”
echo “”
echo “# Avec Django-Q (settings.py):”
echo “Q_CLUSTER = {”
echo “    ‘name’: ‘DjangORM’,”
echo “    ‘workers’: 4,”
echo “    ‘timeout’: 90,”
echo “    ‘retry’: 120,”
echo “    ‘queue_limit’: 50,”
echo “    ‘bulk’: 10,”
echo “    ‘orm’: ‘default’,”
echo “}”
echo “”
echo “# Schedule dans Django admin ou code:”
echo “from django_q.tasks import schedule”
echo “from django_q.models import Schedule”
echo “”
echo “schedule(‘api.tasks.update_node_health’,”
echo “         schedule_type=Schedule.MINUTES,”
echo “         minutes=0.5)  # Toutes les 30 secondes”
echo “”

echo “=== Configuration terminée ===”
