# templatetags/server_filters.py
from django import template
import json
from django.core.serializers.json import DjangoJSONEncoder

register = template.Library()

@register.filter
def server_to_json(server, json_data_str):
    """
    Convertit un serveur en JSON en utilisant la structure du json_data
    json_data_str: le JSON stringifié depuis le template
    """
    # Parser le json_data
    json_data = json.loads(json_data_str) if isinstance(json_data_str, str) else json_data_str
    
    # Construire le dictionnaire avec tous les champs définis dans json_data
    data = {'id': server.id}
    
    # Parcourir tous les champs définis dans json_data
    for field_key, field_info in json_data.get('fields', {}).items():
        field_name = field_info.get('inputname')
        
        if field_name and hasattr(server, field_name):
            value = getattr(server, field_name)
            
            # Convertir les dates en ISO format
            if hasattr(value, 'isoformat'):
                value = value.isoformat()
            # Convertir les objets liés en string
            elif hasattr(value, '__str__'):
                value = str(value)
                
            data[field_name] = value
    
    return json.dumps(data, cls=DjangoJSONEncoder)
