# inventory/views.py (ou là où tu mets tes vues)

import json
import os
from django.shortcuts import render
from django.conf import settings
from inventory.models import AnalysisSnapshot

def dashboard_view(request):
    """Dashboard de qualité des données"""
    
    # Charge la config JSON
    config_path = os.path.join(settings.BASE_DIR, 'config', 'dashboard_config.json')
    with open(config_path, 'r') as f:
        config = json.load(f)
    
    # Récupère le dernier snapshot
    try:
        latest_snapshot = AnalysisSnapshot.objects.latest('analysis_date')
    except AnalysisSnapshot.DoesNotExist:
        # Pas encore d'analyse
        context = {
            'no_data': True,
            'message': 'No analysis has been run yet. Please run the discrepancy analysis first.'
        }
        return render(request, 'inventory/dashboard.html', context)
    
    # Prépare les données pour chaque widget
    widgets_data = []
    
    for widget in config['dashboard']['widgets']:
        widget_data = {
            'id': widget['id'],
            'type': widget['type'],
            'size': widget.get('size', 'small'),
            'title': widget['title'],
            'icon': widget.get('icon', ''),
            'link': widget.get('link', '#'),
        }
        
        # Récupère la métrique
        metric_name = widget['metric']
        metric_value = getattr(latest_snapshot, metric_name, 0)
        
        if widget['type'] == 'gauge':
            if widget['size'] == 'large':
                # Grande gauge : affiche le pourcentage directement
                widget_data['value'] = metric_value
                widget_data['display_value'] = f"{metric_value}%"
            else:
                # Petite gauge : calcule le % de serveurs OK pour ce champ
                # metric_value = nombre de serveurs avec problème
                total = latest_snapshot.total_servers_analyzed
                servers_ok = total - metric_value
                percentage_ok = round((servers_ok / total) * 100, 1) if total > 0 else 100
                
                widget_data['value'] = percentage_ok
                widget_data['count'] = metric_value
                widget_data['display_value'] = f"{percentage_ok}%"
                widget_data['detail'] = f"{metric_value} issues"
            
            # Thresholds et couleurs
            widget_data['thresholds'] = widget.get('thresholds', {
                'critical': 80,
                'warning': 95,
                'good': 100
            })
            widget_data['colors'] = widget.get('colors', {
                'critical': '#dc3545',
                'warning': '#ffc107',
                'good': '#28a744'
            })
        
        widgets_data.append(widget_data)
    
    context = {
        'title': config['dashboard']['title'],
        'widgets': widgets_data,
        'snapshot': latest_snapshot,
        'no_data': False,
    }
    
    return render(request, 'inventory/dashboard.html', context)
