// Dans chart-modal.js

// Load automatique quand on sÃ©lectionne
function loadSavedChartAuto() {
    const select = document.getElementById('savedChartSelect');
    const deleteBtn = document.getElementById('deleteChartBtn');
    
    if (!select.value) {
        // Rien sÃ©lectionnÃ© â†’ cacher le bouton delete
        if (deleteBtn) deleteBtn.style.display = 'none';
        return;
    }
    
    // Quelque chose sÃ©lectionnÃ© â†’ afficher le bouton delete
    if (deleteBtn) deleteBtn.style.display = 'flex';
    
    // Charger la vue
    const option = select.options[select.selectedIndex];
    const filters = JSON.parse(option.dataset.filters);
    
    // Reconstruire l'URL
    const params = new URLSearchParams();
    
    if (filters.fields) {
        filters.fields.forEach(field => params.append('fields', field));
    }
    if (filters.types) {
        filters.types.forEach(type => params.append('types', type));
    }
    
    Object.entries(filters).forEach(([key, value]) => {
        if (key !== 'fields' && key !== 'types') {
            params.append(key, value);
        }
    });
    
    // Ouvrir
    window.open(`/charts/?${params.toString()}`, '_blank');
    
    // Reset le select
    select.value = '';
    if (deleteBtn) deleteBtn.style.display = 'none';
}

// Supprimer la vue sÃ©lectionnÃ©e
async function deleteSelectedChart() {
    const select = document.getElementById('savedChartSelect');
    const deleteBtn = document.getElementById('deleteChartBtn');
    
    if (!select.value) {
        alert('No view selected');
        return;
    }
    
    const option = select.options[select.selectedIndex];
    
    if (!confirm(`Delete "${option.textContent}"?`)) return;
    
    try {
        const response = await fetch(`/api/charts/${select.value}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            // Masquer le bouton delete
            deleteBtn.style.display = 'none';
            // Recharger la liste
            loadSavedChartsList();
            // Toast
            showSimpleToast(`View "${option.textContent}" deleted`);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting view');
    }
}

// Toast simple (sans dÃ©pendance)
function showSimpleToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--btn-success);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px var(--shadow);
        z-index: 10001;
        font-size: 14px;
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// Charger la liste (inchangÃ© mais avec reset du bouton delete)
async function loadSavedChartsList() {
    try {
        const response = await fetch('/api/charts/list/');
        
        if (!response.ok) return;
        
        const data = await response.json();
        const select = document.getElementById('savedChartSelect');
        const deleteBtn = document.getElementById('deleteChartBtn');
        
        if (!select) return;
        
        select.innerHTML = '<option value="">ðŸ“‚ Load saved view...</option>';
        
        // Reset le bouton delete
        if (deleteBtn) deleteBtn.style.display = 'none';
        
        if (data.success && Array.isArray(data.charts) && data.charts.length > 0) {
            data.charts.forEach(chart => {
                const option = document.createElement('option');
                option.value = chart.id;
                option.textContent = chart.name;
                option.dataset.filters = JSON.stringify(chart.filters);
                select.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error loading saved charts:', error);
    }
}
