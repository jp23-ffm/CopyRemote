{% extends 'common/dashboard_base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block dashboard_title %}{{ title }}{% endblock %}

{% block dashboard_meta %}
    {% if not no_data %}
        Last analysis: {{ snapshot.analysis_date|date:"d M Y H:i" }}<br>
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    /* â”€â”€ Pleine largeur â”€â”€ */
    .dashboard,
    .dashboard-header {
        max-width: 100%;
    }

    /* â”€â”€ Background â”€â”€ */
    body {
        background-color: #f4f6f9;
    }
    [data-theme="dark-mode"] body {
        background-color: #161b22;
    }

    /* â”€â”€ Header â”€â”€ */
    .dashboard-header {
        background: #fff;
        border-radius: 12px;
        padding: 18px 28px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.07);
        border-left: 5px solid #A0826D;
        margin-bottom: 28px;
    }
    [data-theme="dark-mode"] .dashboard-header {
        background: #1e1e2e;
        border-left-color: #B8956A;
    }
    .dashboard-header h1 {
        font-size: 1.5rem;
    }

    /* â”€â”€ Hero gauge â€” rÃ©duite â”€â”€ */
    .hero-gauge {
        padding: 20px;
        max-width: 320px;
    }
    .hero-gauge-card {
        padding: 24px 32px;
    }
    .hero-gauge-card h2 {
        font-size: 1.1rem;
        margin-bottom: 16px;
        color: var(--text-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }
    .hero-gauge-container {
        width: 200px;
        height: 100px;
    }
    .hero-gauge-value {
        font-size: 2rem;
        top: 58%;
    }
    .hero-gauge-stats {
        margin-top: 20px;
        font-size: 0.88rem;
        gap: 0;
    }
    .hero-gauge-stats > div {
        padding: 0 14px;
    }

    /* Couleurs dans les stats */
    .stat-clean span  { color: #28a745; font-weight: 700; }
    .stat-issues span { color: #dc3545; font-weight: 700; }
    .stat-total span  { color: var(--text-primary); font-weight: 700; }

    /* â”€â”€ Mini gauge cards â”€â”€ */
    .gauge-card {
        border-radius: 10px;
        padding: 18px 16px;
    }
    .gauge-card-canvas-container {
        width: 150px;
        height: 100px;
    }
    .gauge-card-value {
        font-size: 1.5rem;
    }
    .gauge-card-header {
        min-height: 48px;
        align-items: center;
        flex-wrap: wrap;
        justify-content: center;
    }
    .gauge-card-title {
        font-size: 0.9rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        white-space: normal;
        text-align: center;
    }

    /* â”€â”€ Grid background â”€â”€ */
    .gauges-grid {
        background: transparent;
        gap: 16px;
        padding-left: 60px;
        padding-right: 60px;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }

    /* â”€â”€ Historic + Exclusions alignement â”€â”€ */
    .historic-section,
    .exclusions-section {
        margin-left: 60px;
        margin-right: 60px;
    }

    /* â”€â”€ Historic section â”€â”€ */
    .historic-section {
        background: #fff;
    }
    [data-theme="dark-mode"] .historic-section {
        background: #1e1e2e;
    }

    /* â”€â”€ Tooltips â”€â”€ */
    .gauge-tooltip {
        background: #1e293b;
        color: #f1f5f9;
        border: none;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.82rem;
        line-height: 1.5;
        box-shadow: 0 6px 20px rgba(0,0,0,0.25);
        border-left: 3px solid #A0826D;
        max-width: 420px;
    }
    .gauge-tooltip::after {
        border-top-color: #1e293b;
    }
    [data-theme="dark-mode"] .gauge-tooltip {
        background: #e2e8f0;
        color: #1e293b;
        box-shadow: 0 6px 20px rgba(0,0,0,0.5);
        border-left-color: #B8956A;
    }
    [data-theme="dark-mode"] .gauge-tooltip::after {
        border-top-color: #e2e8f0;
    }
</style>
{% endblock %}

{% block no_data_additional_sections %}
{% if exclusions.rows %}
<div class="exclusions-section">
    <div class="exclusions-header">
        <h2>Excluded Servers</h2>
        <span class="exclusions-count">{{ exclusions.count }} server(s)</span>
    </div>
    <div class="exclusions-table-wrapper">
        <table class="exclusions-table">
            <thead>
                <tr>
                    {% for header in exclusions.headers %}
                    <th>{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in exclusions.rows %}
                <tr>
                    {% for cell in row %}
                    <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block hero_section %}
    <!-- Hero gauge: Overall quality -->
    <div class="hero-section">
        {% for widget in widgets %}
            {% if widget.size == 'large' %}
			<div class="hero-gauge">
				<a href="{{ widget.link }}" class="hero-gauge-card" {% if widget.info %}data-info="{{ widget.info }}"{% endif %}>
					<h2>{{ widget.title }}</h2>
					<div class="hero-gauge-container">
						<canvas id="gauge-{{ widget.id }}"></canvas>
						<div class="hero-gauge-value">{{ widget.display_value }}</div>
					</div>
					<div class="hero-gauge-stats">
						<div class="stat-clean">Clean: <span>{{ snapshot.servers_clean }}</span></div>
						<div class="stat-issues">Issues: <span>{{ snapshot.servers_with_issues }}</span></div>
						<div class="stat-total">Total: <span>{{ snapshot.total_servers_analyzed }}</span></div>
					</div>
					{% if widget.info %}<div class="gauge-tooltip">{{ widget.info }}</div>{% endif %}
				</a>
            </div>
			
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}

{% block widgets_grid %}
    <!-- Mini gauges grid: Per-field quality -->
    <div class="gauges-grid">
        {% for widget in widgets %}
            {% if widget.size == 'small' %}
            <a href="{{ widget.link }}" class="gauge-card" {% if widget.info %}data-info="{{ widget.info }}"{% endif %}>
                <div class="gauge-card-header">
                    <span class="gauge-card-icon">{{ widget.icon }}</span>
                    <h3 class="gauge-card-title">{{ widget.title }}</h3>
                </div>
                <div class="gauge-card-canvas-container">
                    <canvas id="gauge-{{ widget.id }}"></canvas>
                    <div class="gauge-card-value">{{ widget.display_value }}</div>
                </div>
                <div class="gauge-card-detail">{{ widget.detail }}</div>
                {% if widget.info %}<div class="gauge-tooltip">{{ widget.info }}</div>{% endif %}
            </a>
            {% endif %}
        {% endfor %}
    </div>
{% endblock %}

{% block historic_section %}
    {% if historic_config %}
    <!-- Historic trend section -->
    <div class="historic-section">
        <div class="historic-header">
            <h2>ðŸ“ˆ {{ historic_config.title }}</h2>
            
            <!-- Metric selector dropdown -->
            <select id="metric-selector" class="metric-selector">
                {% for metric in historic_config.metrics %}
                <option 
                    value="{{ metric.id }}"
                    data-metric="{{ metric.metric }}"
                    data-color="{{ metric.color }}"
                    {% if forloop.first %}selected{% endif %}>
                    {{ metric.label }}
                </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- Trend chart canvas -->
        <div class="trend-chart-container">
            <canvas id="trend-chart"></canvas>
        </div>
    </div>
    {% endif %}
{% endblock %}

{% block additional_sections %}
{% if exclusions.rows %}
<div class="exclusions-section">
    <div class="exclusions-header">
        <h2>Excluded Servers</h2>
        <span class="exclusions-count">{{ exclusions.count }} server(s)</span>
    </div>
    <div class="exclusions-table-wrapper">
        <table class="exclusions-table">
            <thead>
                <tr>
                    {% for header in exclusions.headers %}
                    <th>{{ header }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
                {% for row in exclusions.rows %}
                <tr>
                    {% for cell in row %}
                    <td>{{ cell }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
    <!-- Load trend chart JS -->
    <script src="{% static 'discrepancies/js/trend.js' %}"></script>
    
    <script>
        // Initialize all gauges
        {% for widget in widgets %}
        createGauge(
            'gauge-{{ widget.id }}',
            {{ widget.value }},
            {{ widget.thresholds|safe }},
            {{ widget.colors|safe }},
            {% if widget.size == 'large' %}true{% else %}false{% endif %}
        );
        {% endfor %}
        
        // Initialize trend chart if historic data is available
        {% if trend_data %}
        initTrendChart(
            {{ trend_data.dates|safe }},
            {{ trend_data.values|safe }},
            '{{ historic_config.metrics.0.color }}',
            '{{ historic_config.metrics.0.label }}'
        );
        {% endif %}

    </script>
{% endblock %}
