// Remplace la fonction exportAllChartsToPDF() dans ton code par celle-ci :

async function exportAllChartsToPDF() {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p', 'mm', 'a4');
    
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();
    const margin = 20;
    const usableWidth = pageWidth - (2 * margin);
    const usableHeight = pageHeight - (2 * margin);
    
    // Dimensions optimales pour le PDF (ratio 16:9 ou 4:3)
    const optimalChartWidth = 160; // mm - laisse de la marge
    const optimalChartHeight = 100; // mm - ratio ~16:10
    
    pdf.setFontSize(22);
    pdf.text('Analytics Report', margin, 30);
    
    pdf.setFontSize(11);
    pdf.text(`Generated: ${new Date().toLocaleString()}`, margin, 40);
    pdf.text(`Total Servers Analyzed: {{ total_servers }}`, margin, 47);
    
    let yPosition = 60;
    
    // Créer des canvas temporaires avec dimensions fixes pour l'export
    for (let i = 0; i < chartCanvases.length; i++) {
        const { canvas, name, data } = chartCanvases[i];
        
        // Vérifier si on a besoin d'une nouvelle page
        if (yPosition + optimalChartHeight + 50 > pageHeight - margin) {
            pdf.addPage();
            yPosition = margin;
        }
        
        // Titre du graphique
        pdf.setFontSize(14);
        pdf.setFont(undefined, 'bold');
        pdf.text(name, margin, yPosition);
        yPosition += 8;
        
        // Créer un canvas temporaire avec dimensions optimales
        const tempCanvas = document.createElement('canvas');
        // Utiliser une résolution élevée pour la qualité
        const scale = 2; // Augmente la résolution
        tempCanvas.width = optimalChartWidth * scale * 3.78; // conversion mm vers px (approximatif)
        tempCanvas.height = optimalChartHeight * scale * 3.78;
        
        const tempCtx = tempCanvas.getContext('2d');
        
        // Fond blanc (important pour le PDF)
        tempCtx.fillStyle = 'white';
        tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
        
        // Dessiner l'image originale centrée et proportionnée
        const aspectRatio = canvas.width / canvas.height;
        const targetAspectRatio = optimalChartWidth / optimalChartHeight;
        
        let drawWidth, drawHeight, offsetX = 0, offsetY = 0;
        
        if (aspectRatio > targetAspectRatio) {
            // Image plus large
            drawWidth = tempCanvas.width;
            drawHeight = tempCanvas.width / aspectRatio;
            offsetY = (tempCanvas.height - drawHeight) / 2;
        } else {
            // Image plus haute
            drawHeight = tempCanvas.height;
            drawWidth = tempCanvas.height * aspectRatio;
            offsetX = (tempCanvas.width - drawWidth) / 2;
        }
        
        tempCtx.drawImage(canvas, offsetX, offsetY, drawWidth, drawHeight);
        
        // Convertir en image pour le PDF
        const imgData = tempCanvas.toDataURL('image/png');
        pdf.addImage(imgData, 'PNG', margin, yPosition, optimalChartWidth, optimalChartHeight);
        yPosition += optimalChartHeight + 8;
        
        // Mini tableau Top 5
        pdf.setFontSize(10);
        pdf.setFont(undefined, 'bold');
        pdf.text('Top 5:', margin, yPosition);
        yPosition += 5;
        
        pdf.setFont(undefined, 'normal');
        const top5 = data.table_labels.slice(0, 5);
        const top5Values = data.table_values.slice(0, 5);
        const total = data.table_values.reduce((a, b) => a + b, 0);
        
        top5.forEach((label, idx) => {
            const value = top5Values[idx];
            const percentage = ((value / total) * 100).toFixed(1);
            const text = `${idx + 1}. ${label}: ${value} (${percentage}%)`;
            pdf.text(text, margin + 3, yPosition);
            yPosition += 5;
        });
        
        yPosition += 10;
    }
    
    // Footer sur toutes les pages
    const pageCount = pdf.internal.getNumberOfPages();
    for (let i = 1; i <= pageCount; i++) {
        pdf.setPage(i);
        pdf.setFontSize(9);
        pdf.setTextColor(150);
        pdf.text(`Page ${i} of ${pageCount}`, pageWidth - margin - 20, pageHeight - 10);
        pdf.text('Chimera Inventory - Analytics', margin, pageHeight - 10);
    }
    
    const filename = `analytics_report_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(filename);
    
    showToast('PDF exported successfully!');
}
