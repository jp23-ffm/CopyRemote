// common/static/common/js/settings-modal.js

let currentAppNameSettings = 'inventory';  // Sera initialisé

function initSettingsModal(appName) {
    currentAppNameSettings = appName;
    loadAllSettings();
}

function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Synchroniser l'état du toggle avec le thème actuel
    const isDark = document.documentElement.classList.contains('dark-mode');
    document.getElementById('themeToggle').checked = isDark;
}

function closeSettingsModal() {
    const modal = document.getElementById('settingsModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

// Toggle theme depuis le modal
function toggleThemeFromSettings() {
    const checkbox = document.getElementById('themeToggle');
    const newTheme = checkbox.checked ? 'dark' : 'light';
    
    // Appliquer immédiatement
    applyTheme(newTheme);
    
    // Sauvegarder localStorage
    localStorage.setItem('theme', newTheme);
    
    // Sauvegarder DB
    saveSettingToDB('theme', newTheme);
}

// Charger tous les settings au chargement du modal
async function loadAllSettings() {
    try {
        // Settings globaux
        const globalResponse = await fetch('/common/api/preferences/?app=global');
        const globalData = await globalResponse.json();
        
        if (globalData.success && globalData.settings) {
            // Theme
            if (globalData.settings.theme) {
                const isDark = globalData.settings.theme === 'dark';
                document.getElementById('themeToggle').checked = isDark;
            }
            
            // Language
            if (globalData.settings.language) {
                document.getElementById('language').value = globalData.settings.language;
            }
        }
        
        // Settings de l'app courante
        const appResponse = await fetch(`/common/api/preferences/?app=${currentAppNameSettings}`);
        const appData = await appResponse.json();
        
        if (appData.success && appData.settings) {
            // Items per page
            if (appData.settings.items_per_page) {
                document.getElementById('itemsPerPage').value = appData.settings.items_per_page;
            }
        }
        
    } catch (error) {
        console.error('Error loading settings:', error);
    }
}

// Sauvegarder un setting en DB
async function saveSettingToDB(key, value, appName = 'global') {
    try {
        await fetch('/common/api/preferences/update/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                app_name: appName,
                key: key,
                value: value
            })
        });
    } catch (error) {
        console.error('Error saving setting:', error);
    }
}

// Sauvegarder items per page
function saveItemsPerPage(value) {
    saveSettingToDB('items_per_page', parseInt(value), currentAppNameSettings);
    
    // Toast pour confirmer
    showSimpleToast('Items per page updated');
    
    // Optionnel : recharger la page pour appliquer
    // setTimeout(() => window.location.reload(), 1000);
}

// Sauvegarder language
function saveLanguage(value) {
    saveSettingToDB('language', value, 'global');
    showSimpleToast('Language updated');
}

// Toast (réutiliser celle de chart-modal si déjà présente)
function showSimpleToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--btn-success);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px var(--shadow);
        z-index: 10001;
        font-size: 14px;
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// Fermer avec Echap
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        const modal = document.getElementById('settingsModal');
        if (modal && modal.classList.contains('show')) {
            closeSettingsModal();
        }
    }
});

// Fermer en cliquant en dehors
document.addEventListener('click', function(e) {
    const modal = document.getElementById('settingsModal');
    if (e.target === modal) {
        closeSettingsModal();
    }
});

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
