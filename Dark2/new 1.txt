# views.py
from django.db.models import Count
import json

@login_required
def chart_view(request):
    """
    G√©n√®re les graphiques bas√©s sur les filtres actuels.
    R√©utilise la m√™me logique que export_to_file.
    """
    # Charger le JSON
    json_path = os.path.join(settings.BASE_DIR, 'static', 'inventory_custom_filters_%')
    with open(json_path, 'r', encoding='utf-8') as f:
        json_data = json.load(f)
    
    # R√©cup√©rer les champs √† analyser depuis l'URL
    selected_fields = request.GET.getlist('fields')  # Ex: ['SERVER_ID', 'APP_NAME_VALUE']
    chart_types = request.GET.getlist('types')       # Ex: ['bar', 'pie']
    
    # R√©cup√©rer les filtres depuis l'URL (comme dans ton export)
    # Construire requestfilters depuis les param√®tres GET
    requestfilters = {}
    for key, value in request.GET.items():
        if key not in ['fields', 'types', 'page']:  # Ignorer les params sp√©ciaux
            requestfilters[key] = value
    
    # R√©cup√©rer les filtres permanents (si tu les utilises)
    permanent_filter_selection = {}
    # ... ton code pour r√©cup√©rer les filtres permanents
    
    # R√âUTILISER TA FONCTION EXISTANTE !
    servers = get_filtered_servers(requestfilters, permanent_filter_selection)
    
    # G√©n√©rer les donn√©es pour chaque graphique
    charts_data = []
    
    for field_key, chart_type in zip(selected_fields, chart_types):
        if field_key and chart_type:
            # Trouver les infos du champ dans le JSON
            field_info = json_data.get('chartable_fields', {}).get(field_key)
            if not field_info:
                continue
            
            # Le vrai nom du champ dans le mod√®le
            model_field = field_info['inputname']  # ex: "app_name"
            display_name = field_info['displayname']  # ex: "Application Name"
            
            # Agr√©gation pour le graphique (top 20)
            aggregated_chart = (
                servers
                .values(model_field)
                .annotate(count=Count('id'))
                .order_by('-count')
                [:20]
            )
            
            # Agr√©gation pour la table (top 100)
            aggregated_table = (
                servers
                .values(model_field)
                .annotate(count=Count('id'))
                .order_by('-count')
                [:100]
            )
            
            # Calculer "Others"
            total_in_chart = sum(item['count'] for item in aggregated_chart)
            total_servers = servers.count()
            others_count = total_servers - total_in_chart
            
            # Labels et valeurs pour le graphique
            chart_labels = [str(item[model_field]) if item[model_field] else 'Unknown' for item in aggregated_chart]
            chart_values = [item['count'] for item in aggregated_chart]
            
            if others_count > 0:
                chart_labels.append('Others')
                chart_values.append(others_count)
            
            # Labels et valeurs pour la table
            table_labels = [str(item[model_field]) if item[model_field] else 'Unknown' for item in aggregated_table]
            table_values = [item['count'] for item in aggregated_table]
            
            charts_data.append({
                'field': display_name,
                'type': chart_type,
                'labels': chart_labels,
                'values': chart_values,
                'table_labels': table_labels,
                'table_values': table_values,
                'total': total_servers,
            })
    
    context = {
        'charts_data': json.dumps(charts_data),
        'total_servers': servers.count(),
    }
    
    return render(request, 'charts.html', context)
	
	
----------------

// static/js/chart-modal.js

let availableFields = {};
let chartCount = 0;
const MAX_CHARTS = 4;

function initChartModal(jsonData) {
    // Charger les champs chartables depuis le JSON
    availableFields = jsonData.chartable_fields || {};
}

function openChartModal() {
    const modal = document.getElementById('chartModal');
    const container = document.getElementById('chartSelectors');
    
    // Vider et r√©initialiser
    container.innerHTML = '';
    chartCount = 0;
    
    const addBtn = document.getElementById('addChartBtn');
    if (addBtn) addBtn.style.display = 'block';
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Ajouter le premier s√©lecteur
    addChartSelector();
}

function closeChartModal() {
    const modal = document.getElementById('chartModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}

function addChartSelector() {
    if (chartCount >= MAX_CHARTS) {
        alert('Maximum 4 charts allowed');
        return;
    }
    
    chartCount++;
    const container = document.getElementById('chartSelectors');
    const selectorId = `chart-${chartCount}`;
    
    // G√©n√©rer les options depuis le JSON
    const fieldOptions = Object.entries(availableFields)
        .map(([key, value]) => `<option value="${key}">${value.displayname}</option>`)
        .join('');
    
    const showRemoveBtn = container.children.length >= 1;
    
    const div = document.createElement('div');
    div.className = 'chart-selector';
    div.id = selectorId;
    div.innerHTML = `
        <div class="chart-selector-header">
            <label>Chart ${chartCount}</label>
            ${showRemoveBtn ? `<button type="button" class="remove-chart" onclick="removeChartSelector('${selectorId}')">‚úï Remove</button>` : ''}
        </div>
        
        <label class="field-label">Field to analyze:</label>
        <select name="fields" id="field-${chartCount}" onchange="updateChartTypes(${chartCount})" ${chartCount === 1 ? 'required' : ''}>
            <option value="">-- Select a field --</option>
            ${fieldOptions}
        </select>
        
        <label class="field-label">Chart type:</label>
        <select name="types" id="type-${chartCount}" ${chartCount === 1 ? 'required' : ''}>
            <option value="">-- First select a field --</option>
        </select>
    `;
    
    container.appendChild(div);
    
    // Ajouter Remove au premier chart si c'est le 2√®me
    if (container.children.length === 2) {
        const firstChart = container.children[0];
        const firstHeader = firstChart.querySelector('.chart-selector-header');
        if (firstHeader && !firstHeader.querySelector('.remove-chart')) {
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-chart';
            removeBtn.textContent = '‚úï Remove';
            removeBtn.onclick = () => removeChartSelector('chart-1');
            firstHeader.appendChild(removeBtn);
        }
    }
    
    if (chartCount >= MAX_CHARTS) {
        document.getElementById('addChartBtn').style.display = 'none';
    }
}

function removeChartSelector(selectorId) {
    const container = document.getElementById('chartSelectors');
    if (container.children.length <= 1) return;
    
    document.getElementById(selectorId).remove();
    chartCount--;
    
    // Retirer Remove du dernier si seul
    if (container.children.length === 1) {
        const lastChart = container.children[0];
        const removeBtn = lastChart.querySelector('.remove-chart');
        if (removeBtn) removeBtn.remove();
    }
    
    if (chartCount < MAX_CHARTS) {
        document.getElementById('addChartBtn').style.display = 'block';
    }
    
    // Renum√©roter
    const selectors = document.querySelectorAll('.chart-selector');
    chartCount = 0;
    selectors.forEach((selector, index) => {
        chartCount++;
        selector.id = `chart-${chartCount}`;
        
        const label = selector.querySelector('.chart-selector-header label');
        if (label) label.textContent = `Chart ${chartCount}`;
        
        const fieldSelect = selector.querySelector('select[name="fields"]');
        const typeSelect = selector.querySelector('select[name="types"]');
        const removeBtn = selector.querySelector('.remove-chart');
        
        if (fieldSelect) {
            fieldSelect.id = `field-${chartCount}`;
            fieldSelect.setAttribute('onchange', `updateChartTypes(${chartCount})`);
            if (chartCount === 1) {
                fieldSelect.setAttribute('required', 'required');
                typeSelect.setAttribute('required', 'required');
            } else {
                fieldSelect.removeAttribute('required');
                typeSelect.removeAttribute('required');
            }
        }
        
        if (typeSelect) typeSelect.id = `type-${chartCount}`;
        if (removeBtn) removeBtn.setAttribute('onclick', `removeChartSelector('chart-${chartCount}')`);
    });
}

function updateChartTypes(chartNumber) {
    const fieldSelect = document.getElementById(`field-${chartNumber}`);
    const typeSelect = document.getElementById(`type-${chartNumber}`);
    const selectedField = fieldSelect.value;
    
    if (!selectedField) {
        typeSelect.innerHTML = '<option value="">-- First select a field --</option>';
        return;
    }
    
    const fieldConfig = availableFields[selectedField];
    const suitableCharts = fieldConfig ? fieldConfig.suitable_charts : ['pie', 'bar', 'doughnut', 'line'];
    
    const chartIcons = { 'pie': 'ü•ß', 'doughnut': 'üç©', 'bar': 'üìä', 'line': 'üìà' };
    const chartLabels = { 'pie': 'Pie Chart', 'doughnut': 'Donut Chart', 'bar': 'Bar Chart', 'line': 'Line Chart' };
    
    typeSelect.innerHTML = '<option value="">-- Select chart type --</option>' +
        suitableCharts.map(type => `<option value="${type}">${chartIcons[type]} ${chartLabels[type]}</option>`).join('');
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    document.documentElement.classList.remove('dark-mode');
    
    const chartForm = document.getElementById('chartForm');
    if (chartForm) {
        chartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // R√©cup√©rer les fields et types
            const formData = new FormData(this);
            
            // R√©cup√©rer TOUS les param√®tres de l'URL actuelle (les filtres)
            const currentParams = new URLSearchParams(window.location.search);
            
            // Ajouter les champs s√©lectionn√©s
            for (let [key, value] of formData.entries()) {
                currentParams.append(key, value);
            }
            
            // Ouvrir la page charts avec tous les param√®tres
            const url = '/charts/?' + currentParams.toString();
            window.open(url, '_blank');
            
            // Fermer le modal
            closeChartModal();
        });
    }
    
    // Fermer en cliquant en dehors
    const modal = document.getElementById('chartModal');
    if (modal) {
        modal.addEventListener('click', function(e) {
            if (e.target === this) closeChartModal();
        });
        
        const modalDialog = modal.querySelector('.modal-dialog');
        if (modalDialog) {
            modalDialog.addEventListener('click', function(e) {
                e.stopPropagation();
            });
        }
    }
    
    // Fermer avec Echap
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape' && modal && modal.classList.contains('show')) {
            closeChartModal();
        }
    });
});


-------------

{% load static %}

<!-- Ton HTML existant... -->

<!-- Charger le script -->
<script src="{% static 'js/chart-modal.js' %}"></script>
<script>
    // Passer le JSON au script
    const jsonData = {{ json_data|safe }};
    initChartModal(jsonData);
</script>
