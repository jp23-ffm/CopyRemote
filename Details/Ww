@login_required
def chart_view(request):
    json_data = get_field_labels()
    
    selected_fields = request.GET.getlist('fields')
    chart_types = request.GET.getlist('types')
    permanent_filter_selection = request.GET.get('permanentfilter')
    
    requestfilters = {}
    for key, value in request.GET.items():
        requestfilters[key] = value
    
    servers = get_filtered_servers(requestfilters, permanent_filter_selection)
    
    if "ANNOTATION" in selected_fields:
        server_ids = list(servers.values_list('SERVER_ID', flat=True).distinct())
        annotations = ServerAnnotation.objects.filter(SERVER_ID__in=server_ids)
        annotation_map = {ann.SERVER_ID_id: ann.notes for ann in annotations}
        
        fields_to_extract = ['SERVER_ID'] + [f for f in selected_fields if f != 'ANNOTATION']
        server_data = list(servers.values(*fields_to_extract).distinct())
        
        for server in server_data:
            server['ANNOTATION'] = annotation_map.get(server['SERVER_ID'], '')
    else:
        fields_to_extract = ['SERVER_ID'] + selected_fields
        server_data = list(servers.values(*fields_to_extract).distinct())
    
    # Pré-calculer les totaux par champ ici
    field_totals = {}
    for field in selected_fields:
        alias_map = {
            'priority_asset': 'server_unique__priority_asset',
            'in_live_play': 'server_unique__in_live_play',
            'action_during_lp': 'server_unique__action_during_lp',
            'original_action_during_lp': 'server_unique__original_action_during_lp',
            'cluster': 'server_unique__cluster',
            'cluster_type': 'server_unique__cluster_type',
            'ANNOTATION': 'ANNOTATION'
        }
        data_field = alias_map.get(field, field)
        
        # Compter les combinaisons uniques (SERVER_ID, valeur)
        unique_combos = set()
        for server in server_data:
            server_id = server.get('SERVER_ID')
            value = server.get(data_field, 'Unknown')
            if value is None or value == '':
                value = 'Unknown'
            unique_combos.add((server_id, str(value)))
        
        field_totals[field] = len(unique_combos)
    
    return generate_charts(request, server_data, json_data, selected_fields, chart_types, field_totals)


@login_required
def generate_charts(request, server_data, json_data, selected_fields, chart_types, field_totals):
    """
    Maintenant on reçoit field_totals déjà calculé !
    """
    
    permanent_filter_selection = request.GET.get('permanentfilter')
    
    filter_text = ""
    filter_parts = []
    
    for key, value in request.GET.items():
        for field_key, field_info in json_data['fields'].items():
            if 'inputname' in field_info and field_info['inputname'] == key:
                fragment = f"{field_info['displayname']}: {value}"
                filter_parts.append(fragment)
    
    filter_parts.append(permanent_filter_selection)
    filter_text = ", ".join(filter_parts)
    
    # Total unique servers
    total_unique_servers = len(set(s['SERVER_ID'] for s in server_data))
    
    charts_data = []
    
    for field_key, chart_type in zip(selected_fields, chart_types):
        if field_key and chart_type:
            field_info = json_data.get('fields', {}).get(field_key)
            if not field_info:
                continue
            
            display_name = field_info['displayname']
            
            alias_map = {
                'priority_asset': 'server_unique__priority_asset',
                'in_live_play': 'server_unique__in_live_play',
                'action_during_lp': 'server_unique__action_during_lp',
                'original_action_during_lp': 'server_unique__original_action_during_lp',
                'cluster': 'server_unique__cluster',
                'cluster_type': 'server_unique__cluster_type',
                'ANNOTATION': 'ANNOTATION'
            }
            
            data_field = alias_map.get(field_key, field_key)
            
            # Compter les occurrences de chaque valeur (dédupliqué par SERVER_ID)
            value_by_server = {}
            for server in server_data:
                server_id = server.get('SERVER_ID')
                value = server.get(data_field, 'Unknown')
                if value is None or value == '':
                    value = 'Unknown'
                
                # Garder une seule valeur par SERVER_ID (en cas de doublons)
                if server_id not in value_by_server:
                    value_by_server[server_id] = str(value)
            
            # Maintenant compter par valeur
            value_counts = {}
            for value in value_by_server.values():
                value_counts[value] = value_counts.get(value, 0) + 1
            
            # Utiliser le total pré-calculé
            field_total_count = field_totals.get(field_key, len(value_by_server))
            
            sorted_items = sorted(value_counts.items(), key=lambda x: x[1], reverse=True)[:19]
            
            top_values_count = sum(count for _, count in sorted_items)
            others_count = field_total_count - top_values_count
            
            chart_labels = [str(value) for value, _ in sorted_items]
            chart_values = [count for _, count in sorted_items]
            
            if others_count > 0:
                chart_labels.append('Others')
                chart_values.append(others_count)
            
            sorted_items_table = sorted(value_counts.items(), key=lambda x: x[1], reverse=True)[:100]
            table_labels = [str(value) for value, _ in sorted_items_table]
            table_values = [count for _, count in sorted_items_table]
            
            top_table_count = sum(table_values)
            others_count_table = field_total_count - top_table_count
            
            if others_count_table > 0:
                table_labels.append('Others')
                table_values.append(others_count_table)
            
            charts_data.append({
                'field': display_name,
                'type': chart_type,
                'labels': chart_labels,
                'values': chart_values,
                'table_labels': table_labels,
                'table_values': table_values,
                'different_values': len(value_counts),
                'total': field_total_count,
            })
    
    context = {
        'charts_data': json.dumps(charts_data),
        'total_servers': total_unique_servers,
        'filter_text': filter_text
    }
    
    return render(request, 'common/charts.html', context)
