{% load static %}
{% load inventory_custom_filters %}
{% load discrepancy_filters %}

<style>
.error-missing {
    background-color: #fee2e2 !important; /* Light red */
    color: #991b1b;
    font-weight: 500;
}

[data-theme="dark"] .error-missing {
    background-color: #7f1d1d !important;
    color: #fca5a5;
}

.error-inconsistent {
    background-color: #fed7aa !important; /* Light orange */
    color: #9a3412;
    font-weight: 500;
}

[data-theme="dark"] .error-inconsistent {
    background-color: #7c2d12 !important;
    color: #fdba74;
}

/* Sort context menu */
.sort-context-menu {
    position: fixed;
    background: #fff;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 9999;
    min-width: 160px;
    padding: 4px 0;
    display: none;
}

[data-theme="dark"] .sort-context-menu {
    background: #1f2937;
    border-color: #374151;
}

.sort-context-menu div {
    padding: 6px 14px;
    cursor: pointer;
    font-size: 13px;
    color: #374151;
}

[data-theme="dark"] .sort-context-menu div {
    color: #d1d5db;
}

.sort-context-menu div:hover {
    background: #f3f4f6;
}

[data-theme="dark"] .sort-context-menu div:hover {
    background: #374151;
}

/* Days Open tooltip */
.tracker-tooltip {
    position: fixed;
    background: #334155;
    color: #e2e8f0;
    border: 1px solid #475569;
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 12px;
    font-family: monospace;
    z-index: 9999;
    pointer-events: none;
    display: none;
    min-width: 180px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.25);
}
[data-theme="dark"] .tracker-tooltip {
    background: #1e293b;
    color: #e2e8f0;
    border-color: #334155;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
}
.tracker-tooltip .tt-row {
    display: flex;
    justify-content: space-between;
    gap: 16px;
    padding: 2px 0;
}
.tracker-tooltip .tt-field {
    color: #94a3b8;
}
.tracker-tooltip .tt-days {
    font-weight: 600;
    color: #f1f5f9;
    white-space: nowrap;
}

</style>


<table id="serversTable">

    <thead class="tablehead">

        {% for field in table_fields %}

            {% if field.displayname == '' %}
                {% comment %} Do nothing {% endcomment %}
            {% else %}

            <th draggable="true" data-field="{{ field.name }}" class="{{ field.name }} resizable {% if field.name == 'SERVER_ID'%}sticky-col-3{% endif %}">

                <input type="text" class="search-input" name="{{ field.inputname }}" placeholder="Search {{ field.displayname }}">
                {% if field.listbox != '' %}
                    <div class="column-title column-title-hidden">{{ field.displayname }}</div>
                    <select id="{{ field.listid }}-listbox" class="{{ field.listid }}-listbox listbox-centered">
                        <option value="">{{ field.listboxmsg }}</option>
                        {% for listboxentry in field.listbox %}
                            <option value="{{ listboxentry }}">{{ listboxentry }}</option>
                        {% endfor %}
                        {% if field.listid == "infraversion" %}
                            <option value="IV1,IV2,IBM">Our Infra (IV1+IV2+IBM)</option>
                        {% endif %}
                    </select>

                {% else %}
                    <div class="column-title">{{ field.displayname }}</div>
                {% endif %}

            </th>

            {% endif %}

        {% endfor %}
        
    </thead>

    <tbody>

        {% for server_group in page_obj.object_list %}

            <!-- Main row (adapted according to mode) -->
            <tr class="server-row flat-row" 
                data-hostname="{{ server_group.hostname }}" 
                id="{{ server_group.hostname|slugify }}-{{ forloop.counter }}">
           
                {% for field in model_fields %}

                    {% if field.name == 'days_open' %}
                    <td class="days_open field-value" data-issues="{{ server_group.tracker_json }}">
                        {% with field_value=server_group.primary_server|lookup:field.name %}
                        {% if field_value %}{{ field_value }}d{% else %}<span class="empty-field">-</span>{% endif %}
                        {% endwith %}
                    </td>
                    {% elif field.name == 'ANNOTATION' %}
                    <td class="ANNOTATION field-value">
                        <div class="annotation-display">
                            <button class="btn-edit-annotation"
                                onclick="editAnnotation('{{ server_group.hostname }}');">
                                {% if server_group.annotation and server_group.annotation.comment %}&#9998;{% else %}&#10133;{% endif %}
                            </button>
                            {% if server_group.annotation and server_group.annotation.comment %}
                                <span class="annotation-notes">
                                    {{ server_group.annotation.comment|truncatechars:50 }}
                                </span>
                            {% endif %}
                        </div>
                    </td>
                    {% else %}

                    {% with field_value=server_group.primary_server|lookup:field.name %}

                    {# Get error CSS class dynamically using custom filter #}
                    {% get_cell_error_class server_group.primary_server field.name validation_errors as error_class %}

                    <td class="{{ field.name }} field-value {{ error_class }} {% if field.is_hostname %}hostname-cell sticky-col-3{% endif %}">

                        {% if field.is_hostname %}
                            <strong>{{ field_value }}</strong>
                        {% elif field_value == 'MISSING' %}
                            <span class="empty-field">MISSING</span>
                        {% elif field_value or field_value == 0 %}
                            {{ field_value }}
                        {% else %}
                            <span class="empty-field">-</span>
                        {% endif %}

                    </td>

                    {% endwith %}

                    {% endif %}

                {% endfor %}

            </tr>



            {% empty %}

            <tr>
                <td colspan="{{ model_fields|length }}" style="text-align: center; padding: 40px; color: #6c757d;">
                    No servers found.
                </td>
            </tr>

        {% endfor %}

    </tbody>

</table>

<!-- Sort context menu -->
<div id="sortContextMenu" class="sort-context-menu">
    <div data-action="asc">Sort ascending</div>
    <div data-action="desc">Sort descending</div>
</div>

<script>
(function() {
    const menu = document.getElementById('sortContextMenu');
    let targetField = null;

    // Right-click on <th>
    document.querySelectorAll('#serversTable thead th[data-field]').forEach(function(th) {
        th.style.cursor = 'context-menu';
        th.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            targetField = th.getAttribute('data-field');
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.style.display = 'block';
        });
    });

    // Click on menu item
    menu.querySelectorAll('div[data-action]').forEach(function(item) {
        item.addEventListener('click', function() {
            if (!targetField) return;
            menu.style.display = 'none';
            var order = item.getAttribute('data-action');
            var url = new URL(window.location.href);
            url.searchParams.set('sort', targetField);
            url.searchParams.set('order', order);
            url.searchParams.set('page', '1');
            window.location.href = url.toString();
        });
    });

    // Close menu on click outside
    document.addEventListener('click', function() {
        menu.style.display = 'none';
    });
})();
// Days Open tooltip
(function() {
    const tooltip = document.createElement('div');
    tooltip.className = 'tracker-tooltip';
    document.body.appendChild(tooltip);

    let showTimer = null;
    let mouseX = 0, mouseY = 0;

    function buildContent(cell) {
        let issues;
        try { issues = JSON.parse(cell.dataset.issues); } catch { return null; }
        const entries = Object.entries(issues);
        if (!entries.length) return null;
        const now = Date.now();
        return entries
            .map(([field, data]) => {
                const days = Math.floor((now - new Date(data.first_seen).getTime()) / 86400000) + 1;
                return { field, days };
            })
            .sort((a, b) => b.days - a.days)
            .map(({ field, days }) =>
                `<div class="tt-row"><span class="tt-field">${field}</span><span class="tt-days">${days}d</span></div>`
            ).join('');
    }

    document.addEventListener('mouseover', function(e) {
        const cell = e.target.closest('td.days_open');
        clearTimeout(showTimer);
        tooltip.style.display = 'none';
        if (!cell || !cell.dataset.issues) return;
        showTimer = setTimeout(function() {
            const html = buildContent(cell);
            if (!html) return;
            tooltip.innerHTML = html;
            tooltip.style.left = (mouseX + 14) + 'px';
            tooltip.style.top  = (mouseY + 14) + 'px';
            tooltip.style.display = 'block';
        }, 800);
    });

    document.addEventListener('mousemove', function(e) {
        mouseX = e.clientX;
        mouseY = e.clientY;
        if (tooltip.style.display === 'none') return;
        tooltip.style.left = (mouseX + 14) + 'px';
        tooltip.style.top  = (mouseY + 14) + 'px';
    });

    document.addEventListener('mouseout', function(e) {
        if (e.target.closest('td.days_open')) {
            clearTimeout(showTimer);
            tooltip.style.display = 'none';
        }
    });
})();

</script>