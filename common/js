// common/static/common/js/chart-modal.js

// Variable globale pour stocker le nom de l'app
let currentAppName = 'inventory';  // Par d√©faut

// Fonction d'initialisation - MODIFI√âE
function initChartModal(jsonData, appName) {
    availableFields = jsonData.chartable_fields || {};
    currentAppName = appName;  // ‚Üê STOCKER le nom de l'app
}

// ... tes autres fonctions ...

// Dans le DOMContentLoaded - submit du formulaire
document.addEventListener('DOMContentLoaded', function() {
    const chartForm = document.getElementById('chartForm');
    if (chartForm) {
        chartForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // R√©cup√©rer les fields et types
            const formData = new FormData(this);
            
            // R√©cup√©rer TOUS les param√®tres de l'URL actuelle (les filtres)
            const currentParams = new URLSearchParams(window.location.search);
            
            // Ajouter les champs s√©lectionn√©s
            for (let [key, value] of formData.entries()) {
                currentParams.append(key, value);
            }
            
            // AJOUTER le param√®tre app
            currentParams.set('app', currentAppName);  // ‚Üê ICI !
            
            // Ouvrir la page charts avec tous les param√®tres
            const url = '/common/charts/?' + currentParams.toString();
            window.open(url, '_blank');
            
            closeChartModal();
        });
    }
    
    // ... reste du code
});

// Load saved chart - MODIFI√â
function loadSavedChartAuto() {
    const select = document.getElementById('savedChartSelect');
    const deleteBtn = document.getElementById('deleteChartBtn');
    
    if (!select.value) {
        if (deleteBtn) deleteBtn.style.display = 'none';
        return;
    }
    
    if (deleteBtn) deleteBtn.style.display = 'flex';
    
    const option = select.options[select.selectedIndex];
    const filters = JSON.parse(option.dataset.filters);
    
    // Reconstruire l'URL
    const params = new URLSearchParams();
    
    // AJOUTER app en premier
    params.set('app', currentAppName);  // ‚Üê ICI !
    
    if (filters.fields) {
        filters.fields.forEach(field => params.append('fields', field));
    }
    if (filters.types) {
        filters.types.forEach(type => params.append('types', type));
    }
    
    Object.entries(filters).forEach(([key, value]) => {
        if (key !== 'fields' && key !== 'types') {
            params.append(key, value);
        }
    });
    
    // Ouvrir
    window.open(`/common/charts/?${params.toString()}`, '_blank');
    
    // Reset
    select.value = '';
    if (deleteBtn) deleteBtn.style.display = 'none';
}

// List saved charts - MODIFI√â
async function loadSavedChartsList() {
    try {
        // PASSER le nom de l'app √† l'API
        const response = await fetch(`/common/api/charts/list/?app=${currentAppName}`);  // ‚Üê ICI !
        
        if (!response.ok) return;
        
        const data = await response.json();
        const select = document.getElementById('savedChartSelect');
        const deleteBtn = document.getElementById('deleteChartBtn');
        
        if (!select) return;
        
        select.innerHTML = '<option value="">üìÇ Load saved view...</option>';
        
        if (deleteBtn) deleteBtn.style.display = 'none';
        
        if (data.success && Array.isArray(data.charts) && data.charts.length > 0) {
            data.charts.forEach(chart => {
                const option = document.createElement('option');
                option.value = chart.id;
                option.textContent = chart.name;
                option.dataset.filters = JSON.stringify(chart.filters);
                select.appendChild(option);
            });
        }
        
    } catch (error) {
        console.error('Error loading saved charts:', error);
    }
}
