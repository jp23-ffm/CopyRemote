// common/static/common/js/chart-modal.js

let chartsLoaded = false;  // Flag pour ne charger qu'une fois

// Charger les saved charts au premier focus/click sur le select
function onSavedChartSelectFocus() {
    if (chartsLoaded) return;  // DÃ©jÃ  chargÃ©, ne rien faire
    
    loadSavedChartsList();
    chartsLoaded = true;
}

// Charger la liste des saved charts
async function loadSavedChartsList() {
    try {
        const response = await fetch('/common/api/charts/list/');
        
        if (!response.ok) {
            console.error('HTTP error:', response.status);
            return;
        }
        
        const data = await response.json();
        const select = document.getElementById('savedChartSelect');
        
        if (!select) return;
        
        // Garder l'option par dÃ©faut
        select.innerHTML = '<option value="">ðŸ“‚ Load saved view...</option>';
        
        if (data.success && Array.isArray(data.charts) && data.charts.length > 0) {
            data.charts.forEach(chart => {
                const option = document.createElement('option');
                option.value = chart.id;
                option.textContent = chart.name;
                option.dataset.filters = JSON.stringify(chart.filters);
                select.appendChild(option);
            });
        } else {
            // Pas de charts sauvegardÃ©s
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '(No saved views yet)';
            option.disabled = true;
            select.appendChild(option);
        }
        
    } catch (error) {
        console.error('Error loading saved charts:', error);
    }
}

// Load automatique quand on sÃ©lectionne
function loadSavedChartAuto() {
    const select = document.getElementById('savedChartSelect');
    const deleteBtn = document.getElementById('deleteChartBtn');
    
    if (!select.value) {
        // Rien sÃ©lectionnÃ© â†’ cacher le bouton delete
        if (deleteBtn) deleteBtn.style.display = 'none';
        return;
    }
    
    // Quelque chose sÃ©lectionnÃ© â†’ afficher le bouton delete
    if (deleteBtn) deleteBtn.style.display = 'flex';
    
    // Charger la vue
    const option = select.options[select.selectedIndex];
    const filters = JSON.parse(option.dataset.filters);
    
    // Reconstruire l'URL
    const params = new URLSearchParams();
    
    if (filters.fields) {
        filters.fields.forEach(field => params.append('fields', field));
    }
    if (filters.types) {
        filters.types.forEach(type => params.append('types', type));
    }
    
    Object.entries(filters).forEach(([key, value]) => {
        if (key !== 'fields' && key !== 'types') {
            params.append(key, value);
        }
    });
    
    // Ouvrir
    window.open(`/inventory/charts/?${params.toString()}`, '_blank');
    
    // Reset le select
    select.value = '';
    if (deleteBtn) deleteBtn.style.display = 'none';
}

// Supprimer la vue sÃ©lectionnÃ©e
async function deleteSelectedChart() {
    const select = document.getElementById('savedChartSelect');
    const deleteBtn = document.getElementById('deleteChartBtn');
    
    if (!select.value) {
        alert('No view selected');
        return;
    }
    
    const option = select.options[select.selectedIndex];
    
    if (!confirm(`Delete "${option.textContent}"?`)) return;
    
    try {
        const response = await fetch(`/common/api/charts/${select.value}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        });
        
        const data = await response.json();
        if (data.success) {
            // Masquer le bouton delete
            deleteBtn.style.display = 'none';
            
            // Recharger la liste
            chartsLoaded = false;  // Forcer le rechargement
            loadSavedChartsList();
            
            showSimpleToast(`View "${option.textContent}" deleted`);
        } else {
            alert('Error: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting view');
    }
}

// Toast simple
function showSimpleToast(message) {
    const toast = document.createElement('div');
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        background: var(--btn-success);
        color: white;
        padding: 12px 20px;
        border-radius: 6px;
        box-shadow: 0 4px 12px var(--shadow);
        z-index: 10001;
        font-size: 14px;
    `;
    
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// RÃ©initialiser le flag quand on ouvre le modal
function openChartModal() {
    const modal = document.getElementById('chartModal');
    const container = document.getElementById('chartSelectors');
    
    // Vider et rÃ©initialiser
    container.innerHTML = '';
    chartCount = 0;
    
    const addBtn = document.getElementById('addChartBtn');
    if (addBtn) addBtn.style.display = 'block';
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // Ajouter le premier sÃ©lecteur
    addChartSelector();
    
    // RÃ©initialiser le flag de chargement (optionnel)
    // chartsLoaded = false;  // DÃ©commenter si tu veux recharger Ã  chaque ouverture
}

function closeChartModal() {
    const modal = document.getElementById('chartModal');
    modal.classList.remove('show');
    document.body.style.overflow = '';
}
